# HTTP/2 Server Push Configuration
# This file contains HTTP/2 server push and preloading directives

# Enable HTTP/2
http2 on;
http2_push_preload on;

# Critical CSS Inlining
# These CSS files will be inlined and pushed immediately
map $request_uri $critical_css {
    default "/assets/css/critical.css";
    ~^/admin "/assets/css/admin-critical.css";
    ~^/blog "/assets/css/blog-critical.css";
}

# Asset Preloading
# Preload critical resources
map $request_uri $preload_assets {
    default "/assets/css/main.css;/assets/js/main.js;/assets/fonts/inter.woff2";
    ~^/admin "/assets/css/admin.css;/assets/js/admin.js";
    ~^/blog "/assets/css/blog.css;/assets/js/blog.js";
}

# Font Loading Strategy
# Use font-display: swap for web fonts
map $uri $font_preload {
    ~* \.woff2$ "font/woff2; crossorigin";
    ~* \.woff$ "font/woff; crossorigin";
    ~* \.ttf$ "font/ttf";
}

# Preconnect to external origins
map $request_uri $preconnect_origins {
    default "https://cdn.example.com;https://api.example.com";
}

# DNS Prefetch for third-party domains
map $request_uri $dns_prefetch {
    default "//www.google-analytics.com;//stats.g.doubleclick.net";
}

# Server Push Headers
add_header Link "<$critical_css>; rel=preload; as=style" always;
add_header Link "</assets/js/main.js>; rel=preload; as=script" always;
add_header Link "</assets/fonts/inter.woff2>; rel=preload; as=font; crossorigin" always;

# Preconnect headers
add_header Link "<https://cdn.example.com>; rel=preconnect" always;
add_header Link "<https://api.example.com>; rel=preconnect" always;

# DNS Prefetch headers
add_header Link "<//www.google-analytics.com>; rel=dns-prefetch" always;

# X-DNS-Prefetch-Control
add_header X-DNS-Prefetch-Control "on" always;

# Optimize font loading
add_header Accept-CH "Sec-CH-Prefers-Color-Scheme" always;
add_header Vary "Sec-CH-Prefers-Color-Scheme" always;
